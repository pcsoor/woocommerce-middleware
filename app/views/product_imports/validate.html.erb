<!-- app/views/product_imports/validate.html.erb -->
<%= render "import_steps", current_step: 2 %>

<div class="card bg-base-100 border border-base-300">
  <div class="card-body">
    <div class="flex justify-between items-start mb-6">
      <div>
        <h1 class="card-title text-3xl">Validate Products</h1>
        <p class="text-base-content/70 mt-2">Review your imported products and fix any issues before continuing</p>
      </div>
      <div class="text-right text-sm opacity-70">
        <div>File: <%= @summary["filename"] %></div>
        <div>Uploaded: <%= time_ago_in_words(session[:import_data]["timestamp"]) %> ago</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="stat bg-base-200 rounded-lg">
        <div class="stat-value text-center"><%= @products.count %></div>
        <div class="stat-title text-center">Total Products</div>
      </div>

      <div class="stat bg-success/10 rounded-lg border border-success/20">
        <div class="stat-value text-center text-success"><%= @valid_products.count %></div>
        <div class="stat-title text-center text-success">Valid Products</div>
      </div>

      <div class="stat bg-warning/10 rounded-lg border border-warning/20">
        <div class="stat-value text-center text-warning"><%= @products_with_warnings.count %></div>
        <div class="stat-title text-center text-warning">With Warnings</div>
      </div>

      <div class="stat bg-error/10 rounded-lg border border-error/20">
        <div class="stat-value text-center text-error"><%= @invalid_products.count %></div>
        <div class="stat-title text-center text-error">Invalid Products</div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>Status</th>
            <th>SKU</th>
            <th>Name</th>
            <th>Regular Price</th>
            <th>Issues</th>
          </tr>
        </thead>
        <tbody>
          <% @products.each_with_index do |product, index| %>
            <tr>
              <td>
                <% if product.valid? %>
                  <% if product.has_warnings? %>
                    <div class="badge badge-warning gap-2">
                      Warning
                    </div>
                  <% else %>
                    <div class="badge badge-success gap-2">
                      Valid
                    </div>
                  <% end %>
                <% else %>
                  <div class="badge badge-error gap-2">
                    Invalid
                  </div>
                <% end %>
              </td>
              <td>
                <%= product.sku.present? ? product.sku : '<span class="text-base-content/50 italic">Missing</span>'.html_safe %>
              </td>
              <td>
                <%= product.name.present? ? product.name : '<span class="text-base-content/50 italic">Missing</span>'.html_safe %>
              </td>
              <td>
                <% if product.regular_price.present? && product.regular_price > 0 %>
                  <div class="badge badge-outline">$<%= product.regular_price %></div>
                <% else %>
                  <span class="text-base-content/50 italic">Not set</span>
                <% end %>
              </td>

              <td>
                <div class="max-w-sm">
                  <!-- Validation Errors -->
                  <% if product.errors.any? %>
                    <% product.errors.full_messages.each do |error_message| %>
                      <span class="text-xs"><%= error_message %></span>
                    <% end %>
                  <% end %>

                  <!-- Warnings -->
                  <% if product.has_warnings? %>
                    <% product.warnings.each do |warning| %>
                      <span class="text-xs"><%= warning %></span>
                    <% end %>
                  <% end %>

                  <!-- No issues -->
                  <% if product.valid? && !product.has_warnings? %>
                    <span class="text-xs">No issues</span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <% if @products.empty? %>
        <div class="text-center py-12">
          <h3 class="text-lg font-medium">No products found</h3>
          <p class="text-base-content/60">No products were parsed from your CSV file.</p>
        </div>
      <% end %>
    </div>

    <div class="flex justify-between px-6 py-4 bg-gray-50 items-center border-t border-gray-200 rounded-b-md">
      <div>
        <%= link_to "Back to Upload", new_product_import_path, class: "btn btn-soft" %>
      </div>

      <div>
        <% if @valid_products.any? %>
          <%= link_to "Continue", configure_product_imports_path, class: "btn btn-primary" %>
        <% else %>
          <span class="btn btn-disabled">
            No valid products to import
          </span>
        <% end %>
      </div>
    </div>
  </div>
</div>
